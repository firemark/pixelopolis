<!doctype html>
<html lang="en-us">

<head>
  <script src="pixelopolis.js"></script>
  <script>
    Module.onRuntimeInitialized = _ => {
      Module['canvas'] = document.getElementById('canvas');
      Module.func__init = Module.cwrap('init', 'number', []);
      Module.func__stop = Module.cwrap('stop', 'number', []);
      Module.func__build = Module.cwrap('build', 'number', ['string'], { async: true });
      Module.func__draw = Module.cwrap('draw', 'number', ['number', 'number', 'number'], { async: true });
      Module.func__init();
    };

    async function fetchCode(codeUrl) {
      const response = await fetch(codeUrl);
      if (!response.ok) {
        return;
      }
      document.getElementById('code').innerText = await response.text();

      if (buildAndDrawTimer) {
        clearTimeout(buildAndDrawTimer);
      }
      Module.func__stop();
      Module.func__init();
      buildAndDrawTimer = setTimeout(buildAndDraw, 0);
    }

    let buildAndDrawTimer = null;
    async function buildAndDraw() {
      const code = document.getElementById('code').innerText;
      await Module.func__build(code);
      await Module.func__draw(0, 0, 0);
      buildAndDrawTimer = setTimeout(buildAndDraw, 3000);
    };


    function start() {
      const selectEl = document.querySelector("#select");
      selectEl.addEventListener('change', e => {
        const first = selectEl.value;
        setTimeout(async _ => await fetchCode(first), 0);
      });
      const first = selectEl.value;
      setTimeout(async _ => await fetchCode(first), 0);
    }
  </script>
</head>

<style>
  body {
    color: white;
    background-color: black;
  }

  select {
    border: 1px white solid;
    background-color: black;
    color: white;
  }

  main {
    display: flex;
    width: calc(100vw - 30px);
    height: 90vh;
    margin: 15px;
  }

  #code {
    width: 30%;
    height: 100%;
    overflow-y: scroll;
    white-space: pre;
  }

  #result {
    width: 70%;
    height: 100%;
    overflow: scroll;
  }
</style>

<body onload="start()">
  <label>Select code plz:</label>
  <select id="select">
    <optgroup label="Complex">
      <option>examples/complex/village.css</option>
      <option>examples/complex/mosque.scss</option>
    </optgroup>
    <optgroup label="Basic">
      <option>examples/basic/cone.css</option>
      <option>examples/basic/cube.css</option>
      <option>examples/basic/cylinder.css</option>
      <option>examples/basic/dome.css</option>
      <option>examples/basic/pyramid.css</option>
      <option>examples/basic/triangle.css</option>
    </optgroup>
    <optgroup label="Textures">
      <option>examples/textures/align.css</option>
      <option>examples/textures/bricks.css</option>
      <option>examples/textures/filler.css</option>
      <option>examples/textures/points.css</option>
      <option>examples/textures/series.css</option>
      <option>examples/textures/textures.css</option>
      <option>examples/textures/tiles.css</option>
    </optgroup>
  </select>
  <main>
    <code id="code">
world {
    width: 2000;
    height: 2000;
}

</code>
    <div id="result">
      <canvas id="canvas"></canvas>
    </div>
  </main>
</body>

</html>